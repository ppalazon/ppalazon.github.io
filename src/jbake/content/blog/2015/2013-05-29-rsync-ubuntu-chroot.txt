---
title: Rsync on ubuntu chroot
author: 'Pablo PalazÃ³n'
layout: blog-post
tags: [ ssh, ubuntu, chroot, security ]
---

# Create users and groups

sudo useradd -m devops
sudo usermod -G rsync devops
sudo usermod -s /bin/bash devops
sudo passwd devops

# Configure ssh for chroot

    Subsystem sftp internal-sftp

At the end of file:

    Match Group sftp
        ChrootDirectory %h
        ForceCommand internal-sftp
        X11Forwarding no
        AllowTcpForwarding no

    Match Group rsync
        ChrootDirectory %h
        X11Forwarding no
        AllowTcpForwarding no

# Restart ssh service
sudo service ssh restart

# Create chroot on home directory

sudo chown root:root /home/devops
sudo chmod 0755 /home/devops
cd /home/devops
sudo mkdir {bin,lib}
sudo cp /bin/bash bin/
sudo cp /usr/bin/rsync bin/
sudo cp /bin/cat bin/
sudo mkdir -p home/devops
sudo chown devops:devops home/devops
sudo mkdir .ssh
sudo chown devops:devops .ssh
cd home/devops
sudo ln -s ../../.ssh .ssh

# Copy lib

Check libs with ldd and copy to lib

ldd /bin/bash

linux-vdso.so.1 =>  (0x00007fffeabff000)
libtinfo.so.5 => /lib/x86_64-linux-gnu/libtinfo.so.5 (0x00007fa304338000)
libdl.so.2 => /lib/x86_64-linux-gnu/libdl.so.2 (0x00007fa304134000)
libc.so.6 => /lib/x86_64-linux-gnu/libc.so.6 (0x00007fa303d74000)
/lib64/ld-linux-x86-64.so.2 (0x00007fa304565000)

Copy all to lib as sudo, with the same structure. This can be the result:

# Script copy chroot

    #!/bin/bash
    # This script can be used to create simple chroot environment
    # Written by LinuxCareer.com <http://linuxcareer.com/>
    # (c) 2013 LinuxCareer under GNU GPL v3.0+

    #!/bin/bash

    CHROOT='/var/chroot'
    mkdir $CHROOT

    for i in $( ldd $* | grep -v dynamic | cut -d " " -f 3 | sed 's/://' | sort | uniq )
      do
        cp --parents $i $CHROOT
      done

    # ARCH amd64
    if [ -f /lib64/ld-linux-x86-64.so.2 ]; then
       cp --parents /lib64/ld-linux-x86-64.so.2 /$CHROOT
    fi

    # ARCH i386
    if [ -f  /lib/ld-linux.so.2 ]; then
       cp --parents /lib/ld-linux.so.2 /$CHROOT
    fi

    echo "Chroot jail is ready. To access it execute: chroot $CHROOT"

# Usage script

    # ./chroot.sh /bin/{ls,cat,echo,rm,bash} /usr/bin/vi /etc/hosts

# Copy public key to devops
ssh-copy-id devops@hostname

# Test with ssh and rsync


http://stackoverflow.com/questions/38288/how-do-i-add-a-user-in-ubuntu
http://www.techrepublic.com/blog/opensource/chroot-users-with-openssh-an-easier-way-to-confine-users-to-their-home-directories/229
http://en.wikibooks.org/wiki/OpenSSH/Cookbook/SFTP
http://www.packetwatch.net/documents/guides/2009091101.php
http://how-to.linuxcareer.com/how-to-automatically-chroot-jail-selected-ssh-user-logins
http://oio11.livejournal.com/1209298.html
